---
interface Electron {
  angle: number;
  link: string;
  label: string;
  speed: number; // degrees per second (e.g., 30 = full orbit in 12s)
  direction?: "cw" | "ccw"; // optional, default "cw"
}
interface Ring {
  rotation: number;
  color: string;
  speed?: number; // fallback speed if electrons don't specify
  electrons: Electron[];
}
interface Props {
  text: string;
  rings: Ring[];
}
const { text, rings } = Astro.props;

const ORBIT_WIDTH = 300;
const ORBIT_HEIGHT = 150;
const ORBIT_RX = ORBIT_WIDTH / 2;
const ORBIT_RY = ORBIT_HEIGHT / 2;
const ORBIT_DRAW_DURATION = 2; // seconds
---

<div class="electron-container">
  <div class="center-content">
    <div class="center-text">{text}</div>
    <div class="center-glow"></div>
  </div>

  {
    rings.map((ring, i) => {
      // Fallback speed for ring if electrons don't override
      const fallbackSpeed = ring.speed ?? 30;
      return (
        <div
          class="orbit"
          id={`orbit-${i}`}
          style={`
          --orbit-width: ${ORBIT_WIDTH}px;
          --orbit-height: ${ORBIT_HEIGHT}px;
          --orbit-rotation: ${ring.rotation}deg;
          --orbit-color: ${ring.color};
          --orbit-draw-delay: ${i * 0.2}s;
          --electron-fade-delay: calc(${i * 0.2}s + ${ORBIT_DRAW_DURATION}s);
          --fallback-speed: ${360 / fallbackSpeed}s; /* full orbit duration */
        `}
        >
          <svg class="orbit-svg" viewBox={`0 0 ${ORBIT_WIDTH} ${ORBIT_HEIGHT}`}>
            <ellipse
              class="orbit-path"
              cx={ORBIT_RX}
              cy={ORBIT_RY}
              rx={ORBIT_RX - 1}
              ry={ORBIT_RY - 1}
            />
          </svg>

          {ring.electrons.map((electron) => {
            const duration = 360 / (electron.speed ?? fallbackSpeed); // seconds per full orbit
            const direction =
              electron.direction === "ccw" ? "reverse" : "normal";
            return (
              <a
                href={electron.link}
                class="electron"
                title={electron.label}
                aria-label={electron.label}
                style={`
                --initial-angle: ${electron.angle}deg;
                --orbit-duration: ${duration}s;
                --orbit-direction: ${direction};
              `}
              >
                <div class="electron-visual" />
              </a>
            );
          })}
        </div>
      );
    })
  }
</div>

<style>
  .electron-container {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
    perspective: 1000px;
    contain: layout style paint; /* Stronger containment */
  }

  @media (max-width: 1024px) {
    .electron-container {
      min-height: 350px;
    }
  }
  @media (max-width: 768px) {
    .electron-container {
      min-height: 300px;
    }
  }
  @media (max-width: 480px) {
    .electron-container {
      min-height: 250px;
    }
  }

  .center-content {
    position: relative;
    z-index: 10;
    display: grid;
    place-items: center;
  }

  .center-text {
    font-size: var(--step-1);
    font-weight: 800;
    background: linear-gradient(135deg, var(--gray-12) 0%, var(--gray-10) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-align: center;
    letter-spacing: -0.02em;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
    padding: 1rem 2rem;
    pointer-events: none;
  }

  .center-glow {
    position: absolute;
    width: 120%;
    height: 120%;
    background: radial-gradient(circle, var(--surface-2) 0%, transparent 70%);
    opacity: 0.5;
    filter: blur(20px);
    border-radius: 50%;
  }

  .orbit {
    position: absolute;
    top: 50%;
    left: 50%;
    width: var(--orbit-width);
    height: var(--orbit-height);
    transform: translate(-50%, -50%) rotate(var(--orbit-rotation))
      scale(var(--orbit-scale, 1));
    pointer-events: none;
    will-change: transform;
  }

  .orbit-svg {
    position: absolute;
    inset: 0;
    overflow: visible;
  }

  .orbit-path {
    fill: none;
    stroke: var(--orbit-color);
    stroke-width: 1.5;
    stroke-linecap: round;
    opacity: 0.4;
    stroke-dasharray: 1000;
    stroke-dashoffset: 1000;
    animation: drawOrbit var(--orbit-draw-duration, 2s)
      cubic-bezier(0.4, 0, 0.2, 1) var(--orbit-draw-delay) forwards;
  }

  @keyframes drawOrbit {
    to {
      stroke-dashoffset: 0;
    }
  }

  .electron {
    position: absolute;
    inset: 50%;
    width: 0;
    height: 0;
    pointer-events: auto;
    text-decoration: none;
    opacity: 0;
    animation:
      fadeInElectron 0.6s ease-out var(--electron-fade-delay) forwards,
      orbit var(--orbit-duration, var(--fallback-speed)) linear infinite
        var(--orbit-direction);
    transform: rotate(var(--initial-angle)) translate(var(--orbit-rx, 50%))
      rotate(calc(-1 * var(--initial-angle)));
    transform-origin: 0 0;
    will-change: transform;
  }

  /* Core elliptical orbit animation */
  @keyframes orbit {
    from {
      transform: rotate(0deg) translate(var(--orbit-rx, 50%)) rotate(0deg);
    }
    to {
      transform: rotate(360deg) translate(var(--orbit-rx, 50%)) rotate(-360deg);
    }
  }

  .electron-visual {
    position: absolute;
    top: -8px;
    left: -8px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--orbit-color);
    background-image:
      radial-gradient(
        circle at 30% 30%,
        rgba(255, 255, 255, 0.9),
        transparent 60%
      ),
      radial-gradient(circle at 50% 50%, var(--orbit-color), #000);
    box-shadow:
      0 0 10px var(--orbit-color),
      0 0 20px var(--orbit-color);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    will-change: transform;
    transform: translateZ(0); /* Force GPU layer */
  }

  .electron:hover .electron-visual {
    transform: scale(1.6) translateZ(0);
    box-shadow:
      0 0 15px var(--orbit-color),
      0 0 30px var(--orbit-color),
      0 0 45px var(--orbit-color);
    cursor: pointer;
    z-index: 100;
  }

  .electron:active .electron-visual {
    transform: scale(0.95) translateZ(0);
  }

  @keyframes fadeInElectron {
    from {
      opacity: 0;
      transform: scale(0);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Responsive scaling */
  @media (max-width: 1024px) {
    :root {
      --orbit-scale: 0.9;
    }
  }
  @media (max-width: 768px) {
    :root {
      --orbit-scale: 0.8;
    }
  }
  @media (max-width: 480px) {
    :root {
      --orbit-scale: 0.6;
    }
  }

  .orbit {
    --orbit-scale: var(--orbit-scale, 1);
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .orbit-path,
    .electron,
    .electron-visual {
      animation: none !important;
    }
    .electron {
      opacity: 1;
    }
    .orbit-path {
      stroke-dashoffset: 0;
    }
  }
</style>
