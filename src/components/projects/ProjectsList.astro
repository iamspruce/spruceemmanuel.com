---
import { getCollection } from "astro:content";
const projects = await getCollection("projects");
import { Image } from "astro:assets";

const cardThemes = [
  {
    bg: "--pink-10",
    text: "--pink-1",
    imageBg: "--pink-3",
    outline: "--pink-12",
    halftone: "--pink-9",
  },
  {
    bg: "--green-10",
    text: "--green-1",
    imageBg: "--green-3",
    outline: "--green-12",
    halftone: "--green-9",
  },
  {
    bg: "--purple-10",
    text: "--purple-1",
    imageBg: "--purple-3",
    outline: "--purple-12",
    halftone: "--purple-9",
  },
  {
    bg: "--amber-10",
    text: "--amber-1",
    imageBg: "--amber-3",
    outline: "--amber-12",
    halftone: "--amber-9",
  },
  {
    bg: "--blue-10",
    text: "--blue-1",
    imageBg: "--blue-3",
    outline: "--blue-12",
    halftone: "--blue-9",
  },
  {
    bg: "--red-10",
    text: "--red-1",
    imageBg: "--red-3",
    outline: "--red-12",
    halftone: "--red-9",
  },
];
---

<div
  class="projects-list-wrapper"
  role="region"
  aria-label="Featured projects carousel"
>
  <div class="projects-list">
    <ul class="project-list-items">
      {
        projects.map((project, index) => {
          const theme = cardThemes[index % cardThemes.length];
          return (
            <li
              class="project-list-item"
              role="group"
              aria-roledescription="slide"
              aria-label={`Project: ${project.data.title}`}
              style={`
                --card-bg-color: var(${theme.bg});
                --card-text-color: var(${theme.text});
                --image-wrapper-bg: var(${theme.imageBg});
                --card-outline-color: var(${theme.outline});
                --halftone-color: var(${theme.halftone});
              `}
            >
              <div class="project-list-item-inner">
                <div class="card-number">{index + 1}</div>
                <div class="project-list-content">
                  {project.data.image && (
                    <div class="project-list-content-image">
                      <Image
                        src={project.data.image}
                        alt={project.data.description}
                        widths={[280, 400, 800]}
                        sizes="(max-width: 400px) 280px, 400px"
                      />
                    </div>
                  )}
                  <h3 class="project-list-content-title">
                    {project.data.title}
                  </h3>
                  <p class="project-list-content-description">
                    {project.data.description}
                  </p>
                  <a href={`/posts/${project.slug}`} class="project-link">
                    <span>View Project</span>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="var(--space-l)"
                      height="var(--space-l)"
                      viewBox="0 0 24 24"
                      fill="none"
                    >
                      <path
                        d="M6 18L8.5 15.5M18 6H9M18 6V15M18 6L11.5 12.5"
                        stroke="#1C274C"
                        stroke-width="1.5"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                    </svg>
                  </a>
                </div>
              </div>
            </li>
          );
        })
      }
    </ul>
  </div>
</div>

<style>
  .projects-list-wrapper {
    --card-gap: 2rem;
    perspective: 1200px;
  }
  .projects-list-wrapper::before {
    left: 0;
    background: linear-gradient(to right, var(--gray-1), transparent);
  }

  .projects-list-wrapper::after {
    right: 0;
    background: linear-gradient(to left, var(--gray-1), transparent);
  }

  .projects-list {
    display: flex;
    overflow-x: auto;
    padding-block: 0;
    gap: var(--card-gap);
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    scroll-padding: 0;
  }
  .projects-list::-webkit-scrollbar {
    display: none;
  }

  .project-list-items {
    display: flex;
    gap: var(--card-gap);
    list-style: none;
    margin: 0;
    padding: 0;
    padding-block: var(--space-xl);
  }

  .project-list-item {
    --transform-scroll: perspective(1000px) rotateY(0deg) scale(1) translateZ(0);
    --transform-hover: scale(1.05) rotate(2deg) translateY(-10px);
    --opacity: 1;

    flex: 0 0 clamp(280px, 80vw, 400px);
    scroll-snap-align: center;
    position: relative;

    transform: var(--transform-scroll);
    opacity: var(--opacity);
    will-change: transform, opacity;
    transition:
      transform 0.4s cubic-bezier(0.23, 1, 0.32, 1),
      opacity 0.4s ease;
  }

  .project-list-item:hover {
    --transform-hover: scale(1.05) rotate(2deg) translateY(-10px)
      translateZ(20px);
    z-index: 10;
  }

  .project-list-item-inner {
    background: var(--card-bg-color);
    color: var(--card-text-color);
    border: 3px solid var(--card-outline-color);
    border-radius: 1rem;
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    transform-origin: center;
  }

  .project-list-item-inner::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    background: var(--card-outline-color);
    border: 3px solid var(--card-outline-color);
    transform: translate(8px, 8px);
    z-index: -1;
    transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    will-change: transform;
  }

  .project-list-item:hover .project-list-item-inner::after {
    transform: translate(12px, 12px);
  }

  .card-number {
    position: absolute;
    top: 1rem;
    left: 1rem;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    background-color: var(--card-outline-color);
    color: var(--card-bg-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    font-weight: 700;
    z-index: 5;
    border: 3px solid var(--card-bg-color);
    box-shadow: 0 0 0 3px var(--card-outline-color);
  }

  .project-list-content {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    margin-top: auto;
    color: var(--card-text-color);
  }

  .project-list-content-title {
    margin: 0 0 0.5rem 0;
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--card-text-color);
  }

  .project-list-content-description {
    margin: 0 0 1.5rem 0;
    flex-grow: 1;
    line-height: 1.6;
    font-size: calc(var(--step-0) * 0.7);
  }

  .project-list-content-image {
    position: relative;
    border: 3px solid var(--card-outline-color);
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  .project-list-content-image::after {
    content: "";
    position: absolute;
    inset: 0;
    background-image: radial-gradient(
      circle,
      var(--halftone-color) 1px,
      transparent 1px
    );
    background-size: 4px 4px;
    mix-blend-mode: multiply;
    opacity: 0.6;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .project-list-content-image img {
    display: block;
    width: 100%;
    height: auto;
    aspect-ratio: 16 / 9;
    filter: saturate(1.4) contrast(1.1);
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    transform: translateZ(0);
    backface-visibility: hidden;
  }

  .project-list-item:hover .project-list-content-image img {
    transform: scale(1.1) translateZ(0);
  }

  .project-list-item:hover .project-list-content-image::after {
    opacity: 0.2;
  }

  .project-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 700;
    text-decoration: none;
    text-align: center;
    color: var(--card-text-color);
    background-color: transparent;
    padding: 0.75rem 1.5rem;
    border: 3px solid var(--card-outline-color);
    border-radius: 0.5rem;
    transition: all 0.2s ease-in-out;
    align-self: flex-start;
    width: 100%;
  }
  .project-link svg {
    width: var(--space-l);
    height: var(--space-l);
  }

  .project-link:hover {
    background-color: var(--card-outline-color);
    color: var(--card-bg-color);
    transform: translateY(-2px);
    box-shadow: 4px 4px 0 var(--card-text-color);
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.querySelector(".projects-list");
    if (!container) return;
    const list = container.querySelector(".project-list-items");
    const cards = list.querySelectorAll(".project-list-item");
    if (cards.length === 0) return;

    let isTicking = false;
    const motionQuery = window.matchMedia("(prefers-reduced-motion: reduce)");

    function updateCardStyles() {
      const containerRect = container.getBoundingClientRect();
      const containerCenter = containerRect.left + containerRect.width / 2;
      const containerWidth = containerRect.width;

      cards.forEach((card) => {
        const cardRect = card.getBoundingClientRect();
        const cardCenter = cardRect.left + cardRect.width / 2;
        const distance = cardCenter - containerCenter;
        const distanceFactor = distance / (containerWidth / 2);

        // Clamp distance factor for smooth transitions
        const clampedFactor = Math.max(-1, Math.min(1, distanceFactor));

        const maxScaleChange = 0.12;
        const maxRotationY = 15; // Increased for more pronounced curve
        const maxRotationZ = 8;
        const maxOpacity = 0.4;

        const scale = 1 - Math.abs(clampedFactor) * maxScaleChange;
        const rotationY = clampedFactor * maxRotationY;
        const rotationZ = clampedFactor * maxRotationZ;
        const opacity = 1 - Math.abs(clampedFactor) * maxOpacity;

        card.style.setProperty(
          "--transform-scroll",
          `perspective(1000px) rotateY(${rotationY}deg) rotateZ(${rotationZ}deg) scale(${scale}) translateZ(0)`
        );
        card.style.setProperty("--opacity", opacity);
      });

      isTicking = false;
    }

    function onScroll() {
      if (!isTicking) {
        window.requestAnimationFrame(updateCardStyles);
        isTicking = true;
      }
    }

    function centerMiddleCard() {
      if (cards.length > 0) {
        const middleIndex = Math.floor(cards.length / 2);
        const middleCard = cards[middleIndex];
        const containerCenter = container.offsetWidth / 2;
        const cardCenter = middleCard.offsetLeft + middleCard.offsetWidth / 2;
        const scrollTarget = cardCenter - containerCenter;
        container.scrollLeft = scrollTarget;
      }
    }

    function initCarousel() {
      const firstCard = cards[0];
      if (firstCard) {
        const scrollPadding =
          (container.offsetWidth - firstCard.offsetWidth) / 2;
        list.style.paddingInline = `${scrollPadding}px`;
      }
      centerMiddleCard();
      if (!motionQuery.matches) {
        container.addEventListener("scroll", onScroll, { passive: true });
        updateCardStyles();
      }
    }

    const observer = new ResizeObserver(initCarousel);
    observer.observe(container);
    initCarousel();
  });
</script>
